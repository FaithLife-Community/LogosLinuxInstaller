name: oudedetai
base: core24
adopt-info: oudedetai
summary: Install and maintain FaithLife's Logos Bible (Verbum) Software.
description: |
  This repository contains a Python program for installing and maintaining
  FaithLife's Logos Bible (Verbum) Software on Linux.

  This program is created and maintained by the FaithLife Community and is
  licensed under the MIT License.
grade: stable
confinement: strict
icon: ou_dedetai/img/icon.svg # or post-build: snap/img/icon.svg

platforms:
  amd64:

environment:
  # Define config variables.
  INSTALLDIR: "$SNAP_USER_COMMON"
  WINE_EXE: "$SNAP/bin/wine64"
  WINEBIN_CODE: "Custom"
  # Define runtime variables.
  # https://forum.snapcraft.io/t/modulenotfounderror-no-module-named-tkinter/28707/5?u=n8marti
  TCL_LIBRARY: $SNAP/usr/share/tcltk/tcl8.6
  TK_LIBRARY: $SNAP/usr/share/tcltk/tk8.6
  TCLLIBPATH: $SNAP/usr/lib/tcltk/$CRAFT_ARCH_TRIPLET_BUILD_FOR/tk8.6
  PYTHON_SITE_PKGS: $SNAP/lib/python3.12/site-packages
  PYTHON_APT_PKGS: $SNAP/usr/lib/python3.12
  PYTHON_LIB_DYNLD: $SNAP/usr/lib/python3.12/lib-dynload
  PYTHONPATH: $PYTHON_SITE_PKGS:$PYTHON_APT_PKGS:$PYTHON_LIB_DYNLD
  # https://forum.snapcraft.io/t/libpxbackend-1-0-so-cannot-open-shared-object-file-no-such-file-or-directory/44263/2
  LD_LIBRARY_PATH: $SNAP/usr/lib:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR

apps:
  oudedetai:
    extensions: [gnome]
    command: bin/oudedetai
    plugs: &allplugs
      - audio-playback
      - home
      - network
      - opengl
      - removable-media
      - system-observe
      - system-trace

  logos:
    extensions: [gnome]
    command: bin/run.sh Logos
    plugs: *allplugs

  verbum:
    extensions: [gnome]
    command: bin/run.sh Verbum
    plugs: *allplugs

parts:
  bin:
    source: snap/bin
    plugin: dump
    organize:
      run.sh: bin/run.sh
  #   stage-packages:
  #     - jq

  assets:
    source: ou_dedetai/assets
    plugin: dump
    override-build: |
      find $CRAFT_PROJECT_DIR -maxdepth 4 -type d
      find CRAFT_PART_SRC -maxdepth 4 -type d
      craftctl default
    organize:
      '*': assets/

  img:
    source: ou_dedetai/img
    plugin: dump
    override-build: |
      find $CRAFT_PROJECT_DIR -type d
      find CRAFT_PART_SRC -type d
      craftctl default
    organize:
      '*': img/

  # wine-apt:  # installs most recent devel version
  #   plugin: nil
  #   build-packages: [wget]
  #   override-stage: |
  #     dpkg --add-architecture i386
  #     mkdir -pm755 /etc/apt/keyrings
  #     wget -qO /etc/apt/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key
  #     wget -qNP /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/ubuntu/dists/noble/winehq-noble.sources
  #     apt-get update
  #     apt-get -y install --install-recommends winehq-devel
  #     craftctl default

  wine-custom:
    source: https://github.com/sil-car/wine-builds/releases/download/wine_10.0/wine_10.0+24.04.tar.xz
    plugin: dump
    organize:
      'wine_*/bin': bin
      'wine_*/lib': lib
      'wine_*/share': share
    stage-packages:
      - libavcodec60
      - libavformat60
      - libavutil58
      - libusb-1.0-0
      - libxkbregistry0

  oudedetai:
    source: https://github.com/FaithLife-Community/LogosLinuxInstaller.git
    plugin: python
    override-pull: |
      craftctl default
      craftctl set version=$(git describe --tag)
    stage-packages:
      - libncurses6
      - libncursesw6
      - python3-tk

  cleanup:
    after:
      - wine-custom
      - oudedetai
    plugin: nil
    override-prime: |
      # Remove libraries from snapcraft build lint warnings.
      rm -f lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libicudata.so*
      rm -f usr/lib/libBLTlite.2.5.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libcjson_utils.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libform.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libformw.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libhwy_contrib.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libhwy_test.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libicui18n.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libicuio.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libicutest.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libicutu.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libmenu.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libmenuw.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libpanel.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libpanelw.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libtheora.so*
      rm -f usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libzvbi-chains.so*
